# 開発モードと本番モードの切り替え方法

このプロジェクトでは、Docker環境で開発モードと本番モードを簡単に切り替えることができます。

## 🔧 開発モード（Development）

**特徴:**
- ホットリロード有効
- ソースマップ有効
- 詳細なエラーメッセージ
- ファイル変更を即座に反映
- ページ初回アクセス時にコンパイル
- DB起動時にリセット（`always-reset`モード）

**起動方法:**

```powershell
# PowerShellスクリプトを使う（推奨）
.\scripts\dev.ps1

# または docker-compose コマンド直接実行
docker-compose up --build
```

**アクセス:**
- Next.js: http://localhost:3000
- Adminer (DB管理): http://localhost:8080

---

## 🏭 本番モード（Production）

**特徴:**
- 最適化されたビルド
- ページ遷移が高速（事前コンパイル済み）
- コンパイル時間なし
- バンドルサイズ最小化
- DB永続化（`persist`モード）

**起動方法:**

```powershell
# PowerShellスクリプトを使う（推奨）
.\scripts\prod.ps1

# または docker-compose コマンド直接実行
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up --build
```

**再起動（ビルドなし）:**

```powershell
.\scripts\restart-prod.ps1
```

**アクセス:**
- Next.js: http://localhost:3000

---

## 📊 モード比較表

| 項目 | 開発モード | 本番モード |
|------|-----------|-----------|
| **起動時間** | 速い | 遅い（ビルド必要） |
| **ページ遷移** | 初回は遅い（コンパイル） | 高速 |
| **ホットリロード** | ✅ 有効 | ❌ 無効 |
| **ソースマップ** | ✅ 有効 | ❌ 無効 |
| **バンドルサイズ** | 大きい | 小さい（最適化） |
| **エラー表示** | 詳細 | 簡潔 |
| **DB状態** | 起動毎リセット | 永続化 |
| **PostgreSQL公開** | ✅ 5432ポート | ❌ 非公開 |

---

## 🔄 モード切り替え手順

### 開発 → 本番

```powershell
# 1. 開発モードを停止
docker-compose down

# 2. 本番モードで起動
.\scripts\prod.ps1
```

### 本番 → 開発

```powershell
# 1. 本番モードを停止
docker-compose -f docker-compose.yml -f docker-compose.prod.yml down

# 2. 開発モードで起動
.\scripts\dev.ps1
```

---

## 🛠️ トラブルシューティング

### 本番ビルドが失敗する

```powershell
# コンテナに入ってログ確認
docker exec -it ict-solutions-project bash
cd /workspace/web
npm run build
```

### ビルドキャッシュをクリアしたい

```powershell
# 完全にクリーンアップしてから起動
docker-compose down -v
docker-compose build --no-cache
.\scripts\prod.ps1
```

### ページが表示されない

```powershell
# コンテナのログを確認
docker logs ict-solutions-project

# Next.jsのプロセスを確認
docker exec -it ict-solutions-project bash
ps aux | grep node
```

---

## 💡 Tips

### Turbopackを使う（開発モードのみ）

開発モードでTurbopackを使うとさらに高速化できます：

1. `docker-compose.yml`を編集
2. entrypoint.shで `npm run dev:turbopack` を使うように変更

または、コンテナ内で手動起動：

```bash
docker exec -it ict-solutions-project bash
cd /workspace/web
npm run dev:turbopack
```

### 本番モードでもホットリロードしたい

開発中に「本番ビルドの動作確認」をしたい場合：

```powershell
# 本番ビルド後、開発モードで起動
docker exec -it ict-solutions-project bash
cd /workspace/web
npm run build
npm run dev  # ビルド済みなので高速
```

---

## 📝 環境変数

モードに応じて自動的に設定される環境変数：

| 変数 | 開発モード | 本番モード |
|------|-----------|-----------|
| `NODE_ENV` | `development` | `production` |
| `DB_BOOT_MODE` | `always-reset` | `persist` |

手動で変更したい場合は `.env` ファイルまたは `docker-compose.yml` を編集してください。
