# 環境構築手順

## 1. 前提ソフトウェア

- Git
- Docker (Docker Desktop もしくは Docker Engine)
- 任意のターミナル (PowerShell / bash など)

## 2. 前提ソフトウェアバージョン確認

PowerShell 例:

```powershell
git --version
docker version
docker compose version
```

エラーにならなければ OK。`docker version` で Server 側情報が表示されない場合は Docker Desktop が起動しているか確認してください。

## 3. リポジトリ取得

```powershell
git clone <REPO_URL>
```

## 4. 初回起動

```powershell
docker compose up --build
```

ポイント:

- 初回はコンテナ内で: PostgreSQL 初期化 → 依存 npm install → Prisma migrate → Next.js dev → Caddy 起動
- 数分かかる場合があります (依存パッケージインストール + DB 初期化)。

### 起動ログの例と成功のサイン

以下のようなログが見えたら起動に成功しています。

- `[prisma] migrate deploy done` が表示される
- Next.js の起動行に `Local:        http://localhost:3000` が出る
- `✓ Ready in …s` が表示される
- ブラウザアクセス後に `GET / 200` が記録される

例（抜粋）:

```
ict-solutions-project  | [postgres] ready
ict-solutions-project  | [prisma] migrate deploy done
ict-solutions-project  |    ▲ Next.js 15.5.2 (Turbopack)
ict-solutions-project  |    - Local:        http://localhost:3000
ict-solutions-project  |    - Network:      http://0.0.0.0:3000
ict-solutions-project  |  ✓ Ready in 44.8s
ict-solutions-project  |  GET / 200 in 1702ms
```

注意:

- フォアグラウンドでログが流れ続けます。終了したい場合は別ターミナルから `docker compose down` を実行してください。
- 起動中に Ctrl+C で止めると、次回再起動時に再処理が走り時間がかかる場合があります。

#### 初回フルログ例（参考）

```
=> [internal] load local bake definitions                                                                                                                                                                  0.1s
 => => reading from stdin 553B                                                                                                                                                                              0.1s
 => [internal] load build definition from Dockerfile                                                                                                                                                        0.1s
 => => transferring dockerfile: 5.16kB                                                                                                                                                                      0.1s
 => [internal] load metadata for docker.io/library/ubuntu:24.04                                                                                                                                             3.6s
 => [internal] load .dockerignore                                                                                                                                                                           0.1s
 => => transferring context: 689B                                                                                                                                                                           0.0s
 => [ 1/13] FROM docker.io/library/ubuntu:24.04@sha256:353675e2a41babd526e2b837d7ec780c2a05bca0164f7ea5dbbd433d21d166fc                                                                                     0.1s
 => => resolve docker.io/library/ubuntu:24.04@sha256:353675e2a41babd526e2b837d7ec780c2a05bca0164f7ea5dbbd433d21d166fc                                                                                       0.1s
 => [internal] load build context                                                                                                                                                                           0.1s
 => => transferring context: 7.54kB                                                                                                                                                                         0.1s
 => CACHED [ 2/13] WORKDIR /workspace                                                                                                                                                                       0.0s
 => CACHED [ 3/13] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends     ca-certificates curl gnupg lsb-release git bash build-essential dos2unix;     rm -rf /var/lib/apt/  0.0s
 => CACHED [ 4/13] RUN set -eux;     mkdir -p /usr/share/keyrings;     curl -fsSL [https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key](https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key)     | gpg --dearmor -o /usr/share/keyrings/nodesource.gpg;      0.0s
 => CACHED [ 5/13] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends nodejs;     apt-get clean;     rm -rf /var/lib/apt/lists/*                                              0.0s
 => CACHED [ 6/13] RUN set -eux;     npm config set update-notifier false;     npm config set fund false;     npm config set audit false                                                                    0.0s
 => CACHED [ 7/13] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends postgresql-16 postgresql-client-16 postgresql-contrib-16;     rm -rf /var/lib/apt/lists/*;     sed -i   0.0s
 => CACHED [ 8/13] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends     postgresql-16-postgis-3 postgresql-16-postgis-3-scripts postgis gdal-bin proj-bin;     rm -rf /var  0.0s
 => CACHED [ 9/13] RUN set -eux;     apt-get update;     apt-get install -y --no-install-recommends debian-keyring debian-archive-keyring apt-transport-https curl gnupg ca-certificates;     curl -1sLf '  0.0s
 => CACHED [10/13] RUN set -eux; echo "[versions]"; node -v; npm -v; postgres --version; psql --version; caddy version  # キャッシュ破棄の目印にも                                                                      0.0s[11/13] COPY infra/caddy/Caddyfile /etc/caddy/Caddyfile                                                                                                                                          0.0s
 => CACHED [11/13] COPY infra/caddy/Caddyfile /etc/caddy/Caddyfile                                                                                                                                          0.0s
 => CACHED [12/13] COPY infra/docker/entrypoint.sh /usr/local/bin/entrypoint.sh                                                                                                                             0.0s
 => CACHED [13/13] RUN dos2unix /usr/local/bin/entrypoint.sh && chmod +x /usr/local/bin/entrypoint.sh                                                                                                       0.0s
 => exporting to image                                                                                                                                                                                     33.9s
 => => exporting layers                                                                                                                                                                                     0.0s
 => => exporting manifest sha256:376bf0e27af2d49d64dd72c6211a908b35342b74e3ad7f8fee193f6e36c11590                                                                                                           0.1s
 => => exporting config sha256:c2083b4a65597d7dd34d8280e9f4c8949e9d12fc164a888b91ee000a2cb70059                                                                                                             0.1s
 => => exporting attestation manifest sha256:9b2b6897fb33d156e8665c5cde69b0336efc5d3c7ecdcc32c0cb420b47aaa1a6                                                                                               0.1s
 => => exporting manifest list sha256:d51e75ebc850fadce929a64f5e3688b5b92c27e38b5c6c70649a789dc3c4928b                                                                                                      0.1s
 => => naming to docker.io/library/ict-solutions-project-app:latest                                                                                                                                         0.0s
 => => unpacking to docker.io/library/ict-solutions-project-app:latest                                                                                                                                     33.4s
 => resolving provenance for metadata file                                                                                                                                                                  0.1s
[+] Running 3/3
 ✔ ict-solutions-project-app              Built                                                                                                                                                             0.0s
 ✔ Network ict-solutions-project_default  Created                                                                                                                                                           0.2s
 ✔ Container ict-solutions-project        Created                                                                                                                                                           1.0s
Attaching to ict-solutions-project
ict-solutions-project  | [entrypoint] start container startup sequence
ict-solutions-project  | [postgres] starting cluster
ict-solutions-project  | Removed stale pid file.
ict-solutions-project  | [postgres] waiting for readiness
ict-solutions-project  | [postgres] ready
ict-solutions-project  | [postgres] first-time initialization (db=appdb user=appuser postgis=1)
ict-solutions-project  | [postgis] enabling extension
ict-solutions-project  | NOTICE:  extension "postgis" already exists, skipping
ict-solutions-project  | CREATE EXTENSION
ict-solutions-project  | [node] install dependencies

ict-solutions-project  | added 435 packages in 8m
[prisma] migrate deploy (fallback to db push)
ict-solutions-project  | [prisma] migrate deploy done
Prisma schema loaded from prisma/schema.prisma
ict-solutions-project  |
ict-solutions-project  | ✔ Generated Prisma Client (v6.15.0) to ./node_modules/@prisma/client in 1.51s
ict-solutions-project  |
ict-solutions-project  | Start by importing your Prisma Client (See: https://pris.ly/d/importing-client)
ict-solutions-project  |
ict-solutions-project  | Tip: Want to turn off tips and other hints? [https://pris.ly/tip-4-nohints](https://pris.ly/tip-4-nohints)
ict-solutions-project  |
[next] starting dev server (background)
ict-solutions-project  | [caddy] preparing config
ict-solutions-project  | [caddy] DOMAIN not set -> production block removed
ict-solutions-project  | [caddy] starting (foreground)
ict-solutions-project  |
ict-solutions-project  | > web@0.1.0 dev
ict-solutions-project  | > next dev --turbopack -H 0.0.0.0
ict-solutions-project  |
2025/09/29 17:00:50.455 INFO    maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
ict-solutions-project  | 2025/09/29 17:00:50.458        INFO    GOMEMLIMIT is updated   {"package": "github.com/KimMachineGun/automemlimit/memlimit", "GOMEMLIMIT": 2686036377, "previous": 9223372036854775807}
ict-solutions-project  | 2025/09/29 17:00:50.459        INFO    using config from file  {"file": "/etc/caddy/Caddyfile.effective"}
ict-solutions-project  | 2025/09/29 17:00:50.480        INFO    adapted config to JSON  {"adapter": "caddyfile"}
ict-solutions-project  | 2025/09/29 17:00:50.480        WARN    Caddyfile input is not formatted; run 'caddy fmt --overwrite' to fix inconsistencies    {"adapter": "caddyfile", "file": "/etc/caddy/Caddyfile.effective", "line": 2}
ict-solutions-project  | 2025/09/29 17:00:50.530        INFO    admin   admin endpoint started  {"address": "localhost:2019", "enforce_origin": false, "origins": ["//127.0.0.1:2019", "//localhost:2019", "//[::1]:2019"]}
ict-solutions-project  | 2025/09/29 17:00:50.533        INFO    tls.cache.maintenance   started background certificate maintenance      {"cache": "0xc0001a4000"}
ict-solutions-project  | 2025/09/29 17:00:50.625        INFO    http.auto_https server is listening only on the HTTPS port but has no TLS connection policies; adding one to enable TLS {"server_name": "srv0", "https_port": 443}
ict-solutions-project  | 2025/09/29 17:00:50.625        INFO    http.auto_https enabling automatic HTTP->HTTPS redirects        {"server_name": "srv0"}
ict-solutions-project  | 2025/09/29 17:00:50.626        WARN    http.auto_https server is listening only on the HTTP port, so no automatic HTTPS will be applied to this server {"server_name": "srv1", "http_port": 80}
ict-solutions-project  | 2025/09/29 17:00:50.630        WARN    pki.ca.local    installing root certificate (you might be prompted for password)        {"path": "storage:pki/authorities/local/root.crt"}
ict-solutions-project  | 2025/09/29 17:00:50.632        INFO    warning: "certutil" is not available, install "certutil" with "apt install libnss3-tools" or "yum install nss-tools" and try again
ict-solutions-project  | 2025/09/29 17:00:50.632        INFO    define JAVA_HOME environment variable to use the Java trust
ict-solutions-project  | 2025/09/29 17:00:50.658        INFO    tls     cleaning storage unit   {"storage": "FileStorage:/root/.local/share/caddy"}
ict-solutions-project  | 2025/09/29 17:00:50.675        INFO    tls     finished cleaning storage units
ict-solutions-project  | 2025/09/29 17:00:54.463        INFO    certificate installed properly in linux trusts
ict-solutions-project  | 2025/09/29 17:00:54.465        INFO    http    enabling HTTP/3 listener        {"addr": ":443"}
ict-solutions-project  | 2025/09/29 17:00:54.470        INFO    failed to sufficiently increase receive buffer size (was: 208 kiB, wanted: 7168 kiB, got: 416 kiB). See [https://github.com/quic-go/quic-go/wiki/UDP-Buffer-Sizes](https://github.com/quic-go/quic-go/wiki/UDP-Buffer-Sizes) for details.
ict-solutions-project  | 2025/09/29 17:00:54.476        INFO    http.log        server running  {"name": "srv0", "protocols": ["h1", "h2", "h3"]}
ict-solutions-project  | 2025/09/29 17:00:54.479        WARN    http    HTTP/2 skipped because it requires TLS  {"network": "tcp", "addr": ":80"}
ict-solutions-project  | 2025/09/29 17:00:54.479        WARN    http    HTTP/3 skipped because it requires TLS  {"network": "tcp", "addr": ":80"}
ict-solutions-project  | 2025/09/29 17:00:54.479        INFO    http.log        server running  {"name": "srv1", "protocols": ["h1", "h2", "h3"]}
ict-solutions-project  | 2025/09/29 17:00:54.480        INFO    http    enabling automatic TLS certificate management   {"domains": ["localhost"]}
ict-solutions-project  | 2025/09/29 17:00:54.490        INFO    autosaved config (load with --resume flag)      {"file": "/root/.config/caddy/autosave.json"}
ict-solutions-project  | 2025/09/29 17:00:54.490        INFO    serving initial configuration
ict-solutions-project  | 2025/09/29 17:00:54.500        INFO    tls.obtain      acquiring lock  {"identifier": "localhost"}
ict-solutions-project  | 2025/09/29 17:00:54.514        INFO    tls.obtain      lock acquired   {"identifier": "localhost"}
ict-solutions-project  | 2025/09/29 17:00:54.515        INFO    tls.obtain      obtaining certificate   {"identifier": "localhost"}
ict-solutions-project  | 2025/09/29 17:00:54.570        INFO    tls.obtain      certificate obtained successfully       {"identifier": "localhost", "issuer": "local"}
ict-solutions-project  | 2025/09/29 17:00:54.570        INFO    tls.obtain      releasing lock  {"identifier": "localhost"}
ict-solutions-project  | 2025/09/29 17:00:54.574        WARN    tls     stapling OCSP   {"identifiers": ["localhost"]}
ict-solutions-project  |    ▲ Next.js 15.5.2 (Turbopack)
ict-solutions-project  |    - Local:        http://localhost:3000
ict-solutions-project  |    - Network:      [http://0.0.0.0:3000](http://0.0.0.0:3000)
ict-solutions-project  |
ict-solutions-project  |  ✓ Starting...
ict-solutions-project  | Attention: Next.js now collects completely anonymous telemetry regarding usage.
ict-solutions-project  | This information is used to shape Next.js' roadmap and prioritize features.
ict-solutions-project  | You can learn more, including how to opt-out if you'd not like to participate in this anonymous program, by visiting the following URL:
ict-solutions-project  | [https://nextjs.org/telemetry](https://nextjs.org/telemetry)
ict-solutions-project  |
ict-solutions-project  |  ✓ Ready in 44.8s
ict-solutions-project  |  ○ Compiling / ...
ict-solutions-project  |  ✓ Compiled / in 40.4s
ict-solutions-project  |  GET / 200 in 52864ms
ict-solutions-project  |  GET / 200 in 39658ms
ict-solutions-project  |  GET / 200 in 1702ms
ict-solutions-project  |  GET / 200 in 1901ms
ict-solutions-project  |  GET / 200 in 1452ms

```

## 5. ビルド前のコード品質チェック

本番ビルドや PR 作成前に、以下のコマンドでコードの品質をチェックすることを推奨します。

### ESLint チェック（コーディング規約の確認）

```powershell
docker exec -it ict-solutions-project bash -c "cd /workspace/web && npm run lint"
```

### TypeScript 型チェック

```powershell
docker exec -it ict-solutions-project bash -c "cd /workspace/web && npm run typecheck"
```

### 両方を一度に実行

```powershell
docker exec -it ict-solutions-project bash -c "cd /workspace/web && npm run typecheck && npm run lint"
```

**注意点:**

- これらのチェックはすべてパスすることが必須です（エラー0、警告0）
- 本番ビルド（`npm run build`）を実行する前に必ずチェックしてください
- エラーや警告が残っているとビルドが失敗したり、予期しない動作を引き起こす可能性があります

### チェックが失敗した場合

1. **ESLint エラー**: コーディング規約に違反している箇所を修正してください
2. **TypeScript エラー**: 型の不一致や未定義の変数などを修正してください
3. 修正後、再度チェックコマンドを実行して問題が解消されたか確認してください

## 6. 動作確認

- ブラウザで: http://localhost:3000
- ブラウザで: https://localhost

DB へ直接接続 (例: psql / GUI ツール):

docker-compose.yml で定義されている接続情報:

- ホスト (services.db / ports): localhost
- ポート (ports で 5432:5432): 5432
- DB 名 (環境変数 POSTGRES_DB): appdb
- ユーザ (環境変数 POSTGRES_USER): appuser
- パスワード (環境変数 POSTGRES_PASSWORD): appsecret

## 7. 停止

```powershell
docker compose down
```

## 8. クリーン再構築 (データも消したい場合)

注意: DB 内容が消えます。

```powershell
docker compose down -v
docker compose build --no-cache
docker compose up
```

または一括 (ビルド込み):

```powershell
docker compose down -v; docker compose up --build
```

## 9. 本番ビルド（Production Build）

開発モード（`npm run dev`）ではなく、本番用の最適化されたビルドを実行する場合の手順です。

### 前提: コード品質チェック

**必須**: 本番ビルド前に必ずコード品質チェックを実行してください（セクション5参照）。

```powershell
docker exec -it ict-solutions-project bash -c "cd /workspace/web && npm run typecheck && npm run lint"
```

すべてのエラーと警告が解消されていることを確認してください。

### 本番モードで起動

プロジェクトルートに用意されている PowerShell スクリプトを使用します。

#### 本番モード起動

```powershell
.\scripts\prod.ps1
```

このスクリプトは以下を実行します:

- `docker-compose.yml` + `docker-compose.prod.yml` を組み合わせて起動
- 環境変数 `NODE_ENV=production` を設定
- コンテナ内で `npm run build && npm run start` を実行

#### 開発モードに戻す

```powershell
.\scripts\dev.ps1
```

#### 本番コンテナの再起動

```powershell
.\scripts\restart-prod.ps1
```

### 本番ビルドの確認事項

本番ビルドが成功すると、以下のようなログが表示されます:

```
✓ Compiled successfully in 78s
✓ Linting and checking validity of types
✓ Collecting page data
✓ Generating static pages (24/24)
✓ Collecting build traces
✓ Finalizing page optimization

Route (app)                              Size     First Load JS
┌ ○ /                                    1.2 kB         123 kB
├ ○ /api/events                          0 B                0 B
...
○ (Static)  prerendered as static content

✓ Ready in 27s
Server running on localhost:3000
```

### トラブルシューティング

**ビルドエラーが発生する場合:**

1. セクション5のコード品質チェックを実行
2. すべてのエラーと警告を修正
3. 開発モードで動作確認（`.\scripts\dev.ps1`）
4. 再度本番ビルドを実行

**ポート競合エラーが発生する場合:**

既存のコンテナを停止してから再実行してください:

```powershell
docker compose down
.\scripts\prod.ps1
```
